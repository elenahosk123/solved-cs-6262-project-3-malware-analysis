Download Link: https://assignmentchef.com/product/solved-cs-6262-project-3-malware-analysis
<br>






<h1>Agenda</h1>

<ul>

 <li>Part 1: Analyzing Windows Malware</li>

 <li>Part 2: Analyzing Android Malware</li>

 <li>Analyzing Windows Malware</li>

 <li>You got a malware sample from the wild. Your task is to discover what the malware does by analyzing it</li>

 <li>How do you discover the malware’s behaviors?</li>

 <li>Static Analysis</li>

 <li>Manual Reverse Engineering • Programming binary analysis</li>

 <li>Dynamic Analysis</li>

 <li>Network behavioral tracing</li>

 <li>Run-time system behavioral tracing(File/Process/Thread/Registry)</li>

 <li>Symbolic Execution</li>

 <li>Fuzzing</li>

</ul>




<ul>

 <li>In our scenario, you are going to analyze the given malware with tools that we provide.</li>

 <li>These tools help you to analyze the malware with static and dynamic analysis.</li>

 <li>Objective</li>

</ul>

<ol>

 <li>Find which server controls the malware (the command and control (C2) server)</li>

 <li>Discover how the malware communicates with the command and control (C2) server URL and Payload</li>

 <li>Discover what activities are done by the Linux malware

  <ul>

   <li>Attack activities</li>

   <li>Requirement</li>

   <li>Make sure that no malware traffic goes out from the virtual machine</li>

   <li>But, updating the malware (stage 2), and downloading the Linux malware (stage 3) must be allowed for us to understand the malware’s behavior</li>

   <li>The command and control server is dead. You need to reconstruct it Use tools to reconstruct the server, then reveal hidden behaviors of the malware</li>

   <li>Analyze network traffic on the host, and figure out the list of available commands for the malware</li>

   <li>Analyze network traffic trace of the host, and figure out what malware does</li>

   <li>Write down your answer into assignment-questionnaire.txt</li>

   <li>A Virtual Machine for Malware analysis</li>

   <li>Please install/update to the latest version of VirtualBox.</li>

   <li><a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a></li>

   <li>Download the VM</li>

   <li>Download the project VM from one of the following links</li>

   <li><a href="https://gtvault-my.sharepoint.com/:u:/g/personal/vraymond6_gatech_edu/EeOzzyYd43FDrkx0sw8-xF0Bf4XWBPMHpdatP9gVayO59A?e=3I5kRw">https://gtvault</a><a href="https://gtvault-my.sharepoint.com/:u:/g/personal/vraymond6_gatech_edu/EeOzzyYd43FDrkx0sw8-xF0Bf4XWBPMHpdatP9gVayO59A?e=3I5kRw">sharepoint.com/:u:/g/personal/vraymond6_gatech_edu/EeOzzyYd43FDrkx0sw8</a></li>

  </ul></li>

</ol>

<a href="https://gtvault-my.sharepoint.com/:u:/g/personal/vraymond6_gatech_edu/EeOzzyYd43FDrkx0sw8-xF0Bf4XWBPMHpdatP9gVayO59A?e=3I5kRw">–</a><a href="https://gtvault-my.sharepoint.com/:u:/g/personal/vraymond6_gatech_edu/EeOzzyYd43FDrkx0sw8-xF0Bf4XWBPMHpdatP9gVayO59A?e=3I5kRw">xF0Bf4XWBPMHpdatP9gVayO59A?e=3I5kRw</a>

<ul>

 <li>MD5 Hash: 19E3E05638172762959C4C9E8D89E373</li>

</ul>




<ul>

 <li>Network Configurations</li>

</ul>

Ubuntu

<ul>

 <li>Network Configurations</li>

 <li>tap0</li>

 <li>Virtual network interface for Windows XP IP Address: 192.168.133.101</li>

 <li>br0</li>

 <li>A network bridge between Windows XP and Ubuntu IP Address: 192.168.133.1</li>

 <li>enp0s3</li>

 <li>A network that faces the Internet</li>

 <li>IP Address: 10.0.2.15 (it varies with your VirtualBox settings)</li>

 <li>Open VirtualBox</li>

 <li>Go to File-&gt;Import Appliance.</li>

 <li>Select the ova file and import it.</li>

 <li>For detailed information on how to import the VM, see:</li>

 <li><a href="https://docs.oracle.com/cd/E26217_01/E26796/html/qs-import-vm.html">https://docs.oracle.com/cd/E26217_01/E26796/html/qs</a><a href="https://docs.oracle.com/cd/E26217_01/E26796/html/qs-import-vm.html">–</a><a href="https://docs.oracle.com/cd/E26217_01/E26796/html/qs-import-vm.html">import</a><a href="https://docs.oracle.com/cd/E26217_01/E26796/html/qs-import-vm.html">–</a><a href="https://docs.oracle.com/cd/E26217_01/E26796/html/qs-import-vm.html">html</a></li>

 <li>VM user credentials</li>

 <li>Username: analysis</li>

 <li>Password: analysis</li>

 <li>In the Virtual Machine (VM)</li>

 <li>Files</li>

 <li>py</li>

 <li>This initializes the project environment</li>

 <li>Type your Georgia Tech username (your Canvas login name) after running this</li>

 <li>g $ ./init.py</li>

 <li>sh</li>

 <li>This script updates the VM if any further update has been made by TAs</li>

 <li>Please run this script when you start the project! (If it says that you’re already updated when you run it, that’s fine)</li>

 <li>If you have already completed stage 1 before running update.sh, you do NOT need to redo stage 1 – but you will need to run update.sh to complete stage 2</li>

 <li>sh</li>

 <li>This will archive the answer sheet for submission (create a zip file)</li>

 <li>In the Virtual Machine (VM)</li>

 <li>Directories</li>

 <li>vm</li>

 <li>A directory that stores the Windows XP virtual machine (runs with QEMU) • We use the given VM for both Cuckoo and a testbed. Please see page 19.</li>

 <li>shared</li>

 <li>A shared directory between the Ubuntu host and Windows guest (XP is running on a VM within your project VM). You can copy/move files to or from this directory.</li>

 <li>Please see page 22.</li>

 <li>report</li>

 <li>The answer sheet for project questionnaire.</li>

 <li>setup</li>

 <li>Required files for setting up the machine. You don’t need to modify, nor use the files in this</li>

</ul>

directory.

<ul>

 <li>In the Virtual Machine (VM)</li>

 <li>Directories</li>

 <li>tools</li>

 <li>network</li>

 <li>Configure your network firewall rules (iptables) by editing iptables-rules.</li>

 <li>You can allow/disallow/redirect the traffic from the malware</li>

 <li>‘./reset’ command in this directory will apply the changes</li>

 <li>cfg-generation (CFG stands for Control-Flow Graph)</li>

 <li>An analysis tool that helps you to find interesting functions of malicious activity • You need to edit score.h to generate the control-flow graph</li>

 <li>Use xdot to open the generated CFG.</li>

 <li>In the Virtual Machine (VM)</li>

 <li>Directories</li>

 <li>tools</li>

 <li>sym-exec</li>

 <li>A symbolic executor (based on angr: <a href="https://github.com/angr)">https://github.com/angr)</a></li>

 <li>Helps you to figure out the commands that malware expects</li>

 <li>Use cfg-generation tool to figure out the address of the function of interests</li>

 <li>c2-command</li>

 <li>A simplified tool for C2 server reconstruction</li>

 <li>You can write down command in the *.txt file as a line</li>

 <li>It will randomly choose one command at a time to send to the malware</li>

 <li>Malware</li>

 <li>exe – stage 1 malware</li>

 <li>It will download the stage 2 malware if this malware receives the correct command</li>

 <li>exe – stage 2 malware</li>

 <li>It will download the stage 3 malware if this malware receives the correct command</li>

 <li>exe – the linux malware attack payload</li>

 <li>Analyze the dynamic instruction trace</li>

 <li>Write a script to detect where the C&amp;C communication happens – Find the loop entry point and function sequence in the loop</li>

 <li>Add constraint to symbolic execution to limit the loop to one</li>

 <li>Find the feasible attacks within given set of possible attacks.</li>

</ul>




<h1>Questionnaire</h1>

<ul>

 <li><strong><em><u>1) To get credit for the project, you have to answer the</u></em></strong><strong><em> <u>questionnaire, found at ~/report/assignment-questionnaire.txt !!!!!</u></em></strong></li>

 <li><strong><em><u>2) Please strictly follow the format or the example answer for each question in assignment-questionnaire.txt. TAs use a autograder</u></em></strong></li>

</ul>

<strong><em><u>for your submission.</u></em></strong>

<ul>

 <li>Windows Part</li>

 <li>Read <strong>~/report/assignment-questionnaire.txt</strong></li>

 <li>Carefully read the questions, and answer them in <strong>~/report/assignmentquestionnaire.txt </strong> For each stage, there are 4-6 questions regarding the behavior of the malware.</li>

 <li>Android Part</li>

 <li><strong>READ ~/Android/MaliciousMessenger/writeup.pdf</strong></li>

 <li>Carefully read the writeup, answer in <strong>~/report/assignment-questionnaire.txt</strong></li>

</ul>

<h1>Submitting Questionnaire</h1>

<ul>

 <li>Required files</li>

 <li>Zip the following files and upload to Canvas</li>

 <li>Running ~/archive.sh will automatically zip all of the files</li>

 <li>~/report/assignment-questionnaire.txt</li>

 <li>exe, stage2.exe, payload.exe (linux malware)</li>

 <li>~/tools/network/iptables_rules • ~/tools/cfg-generation/score.h</li>

 <li>Running ~/archive.sh will create report.zip automatically</li>

 <li>Please check the content of your zip file before submitting it to Canvas</li>

 <li>Update the project 3 before begin.</li>

 <li>Open the terminal (Ctrl-Alt-T, or choose terminal from the menu)</li>

 <li>Run, ./update.sh</li>

 <li>It will update any necessary files that are required for this project.</li>

</ul>




<ul>

 <li>Initializing the project</li>

 <li>Open the terminal (Ctrl-Alt-T, or choose terminal from the menu)</li>

 <li>Run ./init.py</li>

 <li>Type your Georgia Tech username (the login name used for Canvas)</li>

 <li>This will download the stage1 malware (stage1.exe) into the ~/shared directory</li>

 <li>Special NOTE</li>

 <li>These are malware samples hosted under the Goergia Tech Network • It is likely that security measures would kick in and encrypt these files</li>

 <li>That is, all the malware samples you will be downloading during this project</li>

 <li><strong>IMPORTANT</strong></li>

 <li>After each download, make sure to check the type of file.</li>

 <li>In the linux VM, execute</li>

 <li>$ file &lt;path-to-exe&gt;</li>

 <li>If the result of that is an archive of some sort then execute:</li>

 <li>unzip &lt;path-to-exe&gt;</li>

 <li>Password: infected</li>

 <li>Special NOTE</li>

 <li>For stage1 and stage2, the file format should be</li>

 <li>For stage3, the file format should be</li>

</ul>




Secure Experiment Environment

<ul>

 <li>We need a secure experiment environment to execute the malware.</li>

 <li>Why?</li>

 <li>Insecure analysis environment could damage your system</li>

 <li>You may not want:</li>

 <li>Encrypting your file during a ransomware analysis</li>

 <li>Infecting machines in your corporate network during a worm analysis</li>

 <li>Creating a tons of infected bot client in your network during a bot/trojan analysis</li>

 <li>The solution:</li>

 <li>Contain malware in a virtual environment</li>

 <li>Virtual Machine</li>

 <li>Virtual Network</li>

 <li>Conservative rules(allow network traffic only if it is secure)</li>

 <li>We provide a Win XP VM as a testbed!</li>

</ul>

<h1>Run Win XP VM</h1>

<ul>

 <li>Run Windows XP Virtual Machine with virt-manager</li>

 <li>Open a terminal</li>

 <li>Type “virt-manager” and double click “winxpsp3”</li>

 <li>Click the icon with the two monitors and click on “basecamp”</li>

</ul>

<h1>Run Win XP VM</h1>

<ul>

 <li>Run Windows XP Virtual Machine with virt-manager</li>

 <li>Right click on basecamp, and click <strong>“Start snapshot.” </strong>Click <strong>Yes </strong>if prompted.</li>

 <li>Once, virt-manager successfully calls the snapshot, click <strong>Show the graphical console</strong>.</li>

 <li>Click on the Windows Start Menu and Turn off Computer.</li>

 <li>Then select Restart</li>

</ul>




<h1>Tutorial – Run Win XP VM</h1>

<ul>

 <li><strong>DO NOT MODIFY OR DELETE THE GIVEN SNAPSHOTS!</strong></li>

 <li>The given snapshots are your backups for your analysis.</li>

 <li>If something bad happens on your testbed, always revert back to the basecamp snapshot.</li>

</ul>

<h1>Tutorial – Copy from Shared Directory</h1>

<ul>

 <li>Go to the shared directory by clicking its icon (in Windows XP)</li>

 <li>Copy stage1.exe into Desktop</li>

 <li>If you execute it in the shared directory, the error message will pop up.</li>

</ul>

Please copy the file to Desktop.

Tutorial – Run the malware!

<ul>

 <li>Now we will run the malware</li>

 <li>Execute stage1.exe (double click the icon)</li>

 <li>It will say “Executing Stage 1 Malware”. Then, click OK.</li>

 <li>You should click OK on each dialog to dismiss it</li>

 <li>Otherwise, malware execution will be blocked</li>

</ul>

Tutorial – Run the malware!

<ul>

 <li>If you want to halt the malware that is running…</li>

 <li>Execute stop_malware in the temp directory.</li>

 <li>This will stop the currently running malware.</li>

 <li>Please halt first before you execute another malware file.</li>

</ul>

<h1>Tutorial – Network behavioral analysis</h1>

<ul>

 <li>To analyze network behaviors, you need</li>

 <li>Wireshark (<a href="https://www.wireshark.org/)">https://www.wireshark.org/)</a></li>

 <li>Network Protocol Analyzer</li>

 <li>Cuckoo (<a href="https://cuckoosandbox.org/)">https://cuckoosandbox.org/)</a></li>

 <li>Capturing &amp; Recording inbound/outbound network packets</li>

</ul>

<h1>Tutorial – Observing Network Behavior</h1>

<ul>

 <li>By capturing and recording network packets through the tools,</li>

 <li>Reveal C&amp;C protocol</li>

 <li>Attack Source &amp; Destination</li>

 <li><strong>But, malware will not do anything. Why?</strong></li>

 <li>The C2 server is dead!</li>

 <li>Therefore, the malware(C2 client) will never unfold its behaviors.</li>

 <li>Question?</li>

 <li>If we know C&amp;C dialog of malware, can we build a fake C2 server in order to unfold the malware behaviors?</li>

 <li>Answer: Hack Yeah! That is your job for this project!</li>

</ul>




<h1>Wireshark</h1>

<ul>

 <li>Let’s check it through network monitoring Open wireshark (open a terminal. Type “sudo wireshark“ – you can ignore the error message that pops up)</li>

 <li>Choose br0 to capture the network traffic</li>

 <li>Then start capture by clicking on the shark-fin on the top left</li>

</ul>

<h1>Tutorial – Redirect Network Connection</h1>

<ul>

 <li>Redirecting Network Connection</li>

 <li></li>

</ul>

<table>

 <tbody>

  <tr>

   <td width="10"></td>

  </tr>

  <tr>

   <td></td>

   <td></td>

  </tr>

 </tbody>

</table>

<ul>

 <li>From WireShark, we can notice that the malware tries to connect to the host at 128.61.240.66, but it fails</li>

 <li>Let’s make it redirect to our fake C2 server</li>

 <li>Go to ~/tools/network</li>

 <li>Edit iptables_rules to redirect the traffic to</li>

</ul>

128.61.240.66 to 192.168.133.1 (fake host)

<ul>

 <li>Whenever you edit iptables_rules, always run reset.</li>

</ul>

(type “./reset” from the ~/tools/network directory)

<ul>

 <li>IMPORTANT! If you shut down your project VM, be sure to run reset again the next time you start it up.</li>

</ul>

<h1>Reading C2 Traffic</h1>

<ul>

 <li>Observing C2 traffic</li>

 <li>In WireShark, we can notice that now the malware can communicate with our fake C2 server</li>

 <li>But there will not be further execution, because the command is wrong…</li>

</ul>




<h1>Reading C2 Traffic</h1>

<ul>

 <li></li>

</ul>

<table>

 <tbody>

  <tr>

   <td width="30"></td>

  </tr>

  <tr>

   <td></td>

   <td></td>

  </tr>

 </tbody>

</table>

<ul>

 <li>Observing C2 traffic</li>

 <li>You can see the contents of the traffic by right-clicking on the line, then clicking Follow – TCP Stream</li>

</ul>

<h1>Cuckoo</h1>

<ul>

 <li>Let’s take a look at cuckoo. Cuckoo is <strong>NOT necessarily required to complete this project</strong>, but it is a useful tool to help you understand what your malware is doing, and therefore how you might want to modify your score.h file later in the project.</li>

 <li>NOTE! You can’t run the testbed vm and cuckoo simultaneously.</li>

 <li></li>

</ul>

<table>

 <tbody>

  <tr>

   <td width="404"></td>

  </tr>

  <tr>

   <td></td>

   <td></td>

  </tr>

 </tbody>

</table>

<ul>

 <li><strong>Always turn off </strong>the testbed vm, and follow the steps below to execute Cuckoo</li>

 <li>Open two terminals.</li>

 <li>$workon cuckoo #Set virtualenv as cuckoo for both terminal1 and terminal2</li>

 <li>$cuckoo –d #To run cuckoo daemon for terminal1</li>

 <li>$cuckoo web #To run cuckoo webserver for terminal2</li>

</ul>

If you get an error when running cuckoo web because port 8000

Is already in use, run “sudo fuser -k 8000/tcp” and try again

<h1>Cuckoo</h1>

<ul>

 <li>The Cuckoo uses a snapshot of the given testbed VM.</li>

 <li>The snapshot is 1501466914 <strong>DO NOT TOUCH </strong>the snapshot!</li>

 <li>When you want to restore the test VM,</li>

 <li><strong>Refer to page 19.</strong></li>

</ul>

<h1>Upload a file to Cuckoo</h1>

<ul>

 <li>To open the cuckoo web server, type the following URL into Chromium</li>

 <li>http://localhost:8000</li>

 <li>To upload a file, click the red box and choose a file.</li>

</ul>

<h1>Analysis with Cuckoo</h1>

<ul>

 <li>Once you click the Analyze button, it will take some time to run the malware.</li>

</ul>

<h1>Analysis on Cuckoo</h1>

<ul>

 <li>Once the pending job is completed, you can view the result • Click the red box</li>

</ul>

<h1>Analysis on Cuckoo(File Info)</h1>

Analysis on Cuckoo(Network Info)

<ul>

 <li></li>

</ul>

<table>

 <tbody>

  <tr>

   <td width="482"></td>

  </tr>

  <tr>

   <td></td>

   <td></td>

  </tr>

 </tbody>

</table>

<ul>

 <li>After redirecting, the result of cuckoo shows high-level information</li>

 <li>Observe the C2 traffic.</li>

 <li>Please compare this result with your Wireshark result.</li>

</ul>

Analysis on Cuckoo(Network Info)

<ul>

 <li>In the network analysis tab, cuckoo provides more detailed info:</li>

</ul>

payload, HTTPs, etc.




<h1>Tutorial – Figuring Out the List of Commands</h1>

<ul>

 <li>The malware does not exhibit its behavior because we did not send the correct command through our fake C2 server</li>

 <li>We will use</li>

 <li>File/Registry/Process tracing analysis to guess the malware behavior.</li>

 <li>control-flow graph (CFG) analysis and symbolic execution to figure out the list of the correct commands</li>

 <li>The purpose of tracing analysis is to draw a big picture of the malware</li>

 <li>What kinds of System call/API does the malware use?</li>

 <li>Does the malware create/read/write a file? How about a registry?</li>

 <li>The purpose of CFG analysis is to find the exact logic that involves the interpretation of the command and the execution of malicious behavior</li>

 <li>Then, symbolic execution finds the command that drives the malware into that execution path</li>

</ul>

Tracing Analysis on Cuckoo

<ul>

 <li>On the side bar, there are useful menus for tracing analysis.</li>

 <li>We are focusing on:</li>

 <li>Static Analysis API/System Call.</li>

 <li>Behavioral Analysis</li>

 <li>Trace behaviors in time sequence.</li>

</ul>

Static Analysis on Cuckoo

<ul>

 <li>Static Analysis</li>

 <li>Information of the malware.</li>

 <li>Win32 PE format information</li>

 <li>Windows binary uses the PE format</li>

 <li>Complicated structure</li>

 <li>Sections includes</li>

 <li>.text</li>

 <li>Strings, etc.</li>

 <li>.data</li>

 <li>.idata</li>

 <li>.reloc</li>

 <li>Virtual link, dynamic link, etc.</li>

 <li><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">More info:</a> <a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">http://resources.infosecinstitute.com/2</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">–</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">malware</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">–</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">researchers</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">–</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">handbook</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">–</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">demystifying</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">–</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">pe</a><a href="http://resources.infosecinstitute.com/2-malware-researchers-handbook-demystifying-pe-file/#gref">file/#gref</a></li>

</ul>

<h1>Static Analysis on Cuckoo</h1>

<ul>

 <li>Interestingly three DLL(Dynamic Link Libaries) files are imported.</li>

 <li>In WININET.dll, we can see that the malware uses http protocol.</li>

 <li>In ADVAPI32.dll, we can check if the malware touches registry files</li>

 <li>In Kernel32.dll, we can check the malware waiting signal, also sleep.</li>

</ul>

Behavior Analysis on Cuckoo

<ul>

 <li>Tracing a behavior(file/process/thread/registry/network) in time sequence.</li>

 <li>Useful to figure out cause-and-effect in process/file/network.</li>

 <li>Malware creates a new file and runs the process, then writes</li>

</ul>

<h1>Cuckoo analysis result</h1>

<ul>

 <li>Based on our analysis with Cuckoo, we can determine if… The malware uses HTTP protocol to communicate</li>

 <li>Communicate with whom? C&amp;C?</li>

 <li>Web server access? For checking if the C2 server is active?</li>

 <li>Commands through http protocol? Cookies?</li>

 <li>The malware touches(create/write/read) a file/registry/process</li>

 <li>This might be a dropper? Or does it download a binary from the C2 server?</li>

 <li>What is the purpose of creating processes? Modifying the registry?</li>

</ul>




<ul>

 <li>Based on the pre-information that we collected from the previous step, we are going to perform CFG analysis &amp; symbolic execution analysis</li>

 <li>CFG:</li>

 <li>graph representation of computation and control flow in the program</li>

 <li>Nodes are basic blocks</li>

 <li>Edges represent possible flow of control from the end of one block to the beginning of the other.</li>

 <li>CFG : An Example</li>

 <li>But, in malware analysis, we are analyzing CFG at the instructionlevel.</li>

 <li>We provide a tool for you that helps to find command interpretation logic and malicious logic</li>

 <li>We list the functions or system calls the malware uses internally</li>

 <li>If you provide the score (how malicious it is, or how likely the malicious logic is to use such a function) for the functions, then the tool will find where the malicious logic is, based on its score</li>

 <li>Example: if you set StrCmpNIA to have a score of 10, then the function that calls StrCmpNIA 5 times within itself will have the score 50.</li>

 <li>A higher score implies that more functions related to the malicious activity are used within the malware.</li>

 <li>Your job is to write the score value per each function More info:</li>

 <li><a href="http://www.cs.cornell.edu/courses/cs412/2008sp/lectures/lec24.pdf">http://www.cs.cornell.edu/courses/cs412/2008sp/lectures/lec24.pdf</a></li>

 <li>From our network analysis, we know that the malware uses an Internet connection to 128.61.240.66</li>

 <li>From our cuckoo-based analysis, we know that the malware uses the HTTP protocol.</li>

 <li>Let’s make the Internet related functions to have higher score</li>

 <li>Open score.h, and edit the score of all of the Internet related functions</li>

 <li>The score is the value at the end (all others are set to 1)</li>

 <li>Build control flow graph</li>

 <li>By executing ./generate.py stage1, the tool gives you the CFG</li>

 <li>This finds the function with higher score</li>

 <li>Implies that this calls high score functions on its execution</li>

 <li>For stage2 Use ’stage2’ as argument</li>

 <li>Note: your graph and its memory addresses will vary from this example</li>

 <li>The function entry is at the address of 405190</li>

 <li>And, there is a function (marked as sub) of score 12</li>

 <li>At the address 40525a (marked in red)</li>

 <li>Use the block_address, not the call sub_address</li>

 <li>This implies that</li>

 <li>sub_4050c0 calls some internet related functions.</li>

 <li>We need to find out what this command is</li>

 <li>Run from 405190 to 40525a</li>

</ul>




<h1>Finding Command</h1>

<ul>

 <li>Finding Commands with Symbolic Execution</li>

 <li>We want to find a command that drives malware from 405190 to 40525a</li>

 <li>Let’s do symbolic execution to figure that out</li>

 <li>What is symbolic execution?</li>

 <li>Rather than executing the program with some input, symbolic execution treats the input data as a symbolic variable, then tries to calculate expressions for the input along the execution.</li>

 <li>Let’s take an example</li>

</ul>

<h1>Example – Symbolic Execution</h1>

<ul>

 <li>What is Symbolic Execution?</li>

</ul>

Symbolic execution moves along the path of conditional statements, and combines all conditions until it reaches the target function. At the end, it solves the expression to get an input that satisfies all of the conditions

<ul>

 <li>Path explosion</li>

 <li>Modeling statements and environments</li>

 <li>Constraint solving</li>

</ul>

<h1>Example1</h1>




<h1>Example1</h1>

In this example, ONLY i=2, j=9 conditions will lead the

program to print <strong>“Correct!”</strong>

Symbolic execution is available to solve the expression in order to reach a target, in this case ”Correct”. Let’s apply it into Malware Command &amp; Control logic. A C&amp;C bot(malware) is expecting inputs(<strong>solve the expressions</strong>) to trigger behaviors(<strong>targets</strong>).

<h1>Example2</h1>

This executes attack() on command ‘launch-attack’, and destroy_itself() on ‘remove’ command

<h1>Example2</h1>

In this example, ONLY  ‘launch-attack’ and ‘remove’ commands(inputs) triggers attack() and destroy_itself().

Symbolic execution is able to find ”launch-attack” as an input to trigger attack(), which is a malicious behavior. Plus, ”remove” will lead to destroy_itself(), which is another behavior.

Our job in this project with Symoblic execution is to find inputs, and then feed the inputs to trigger behaviors.




<h1>Symbolic execution engine</h1>

<ul>

 <li>Symbolic Execution Engine: Klee, Angr, Mayhem, etc.</li>

 <li>Loading a binary into the analysis program</li>

 <li>Translating a binary into an intermediate representation (IR).</li>

 <li>Translating that IR into a semantic representation</li>

 <li>Performing the actual analysis with symbolic execution.</li>

</ul>

For more information: <a href="https://www.cs.umd.edu/~mwh/se-tutorial/symbolic-exec.pdf">https://www.cs.umd.edu/~mwh/se</a><a href="https://www.cs.umd.edu/~mwh/se-tutorial/symbolic-exec.pdf">–</a><a href="https://www.cs.umd.edu/~mwh/se-tutorial/symbolic-exec.pdf">tutorial/symbolic</a><a href="https://www.cs.umd.edu/~mwh/se-tutorial/symbolic-exec.pdf">–</a><a href="https://www.cs.umd.edu/~mwh/se-tutorial/symbolic-exec.pdf">exec.pdf</a>

<h1>Tutorial – Finding Commands with Angr</h1>

<ul>

 <li>We prepared a symbolic executor and a solver for you</li>

 <li>Your job is to find the starting point of the function which interprets the command, and find the end point where malware actually executes some  function that does malicious operations</li>

 <li>Use a Control-flow Graph (CFG) analysis tool!</li>

 <li>The symbolic executor is called angr.(<a href="http://angr.io/index.html">http://angr.io/index.html</a><a href="http://angr.io/index.html">)</a></li>

</ul>

<h1>Tutorial – Finding Command on Angr</h1>

<ul>

 <li>We prepared a symbolic executor and a solver for you</li>

</ul>

<h2>Symbolic Execution – Special Note for stage2.exe</h2>

<ul>

 <li>sys-exec for stage2 takes a lot of time to resolve (up to 20 minutes)</li>

</ul>

– you are welcome to modify the VM performance settings

(memory, cores) based on your hardware to speed this up

<ul>

 <li>If you get a single error message, keep trying again – sym-exec will occasionally fail for stage2</li>

 <li>If your screen is filling up with error messages, then you have the wrong start and/or end address</li>

</ul>

<h1>Tutorial – Reconstructing C2 server</h1>

<ul>

 <li>After CFG analysis + symbolic execution, reconstruct the C2 server</li>

</ul>

<h1>Tutorial – Reconstructing C2 server</h1>

<ul>

 <li>The tool for reconstructing the C2 server is already on the VM</li>

 <li>It runs nginx and php script This will look like ~/tools/c2-command/stage*-command.txt</li>

 <li>Your job is to add your commands to the relevant *.txt file The command that leads the execution from 405190 to 40525a is “$uninstall” (note:</li>

</ul>

the name of the command you see may vary)

<ul>

 <li>Then, type ”$uninstall” and save the file.</li>

 <li>Important: be sure to put the ‘$’ character before your commands, even if stage*- command.txt says that it’s optional</li>

 <li>The order of commands in the file does not matter – they’ll run in a random order Note: This means that if you want to run only a particular command, you’ll need to remove, or comment out the other commands in your file</li>

</ul>

<h1>After that…</h1>

<ul>

 <li>If you find all of the commands for stage1.exe malware, the malware will download stage2.exe by updating itself.</li>

 <li>Now you’ve found the commands from running sym-exec.py</li>

 <li>Add those commands to stage1-commands.txt. Remember to put $&lt;command&gt;.</li>

 <li>Start up the windows VM again, then copy stage1.exe to the desktop. Then double click on it and continue.</li>

 <li>Note if stage1 fails to download stage2, your firewall might be blocking it</li>

 <li>This is actual malware so some IDS have signatures that match it.</li>

</ul>

<h1>After that…</h1>

<ul>

 <li>For stage2.exe, please follow the same steps in the tutorial</li>

 <li>Check its network access with Wireshark</li>

 <li>Redirect network traffic to if required (if the connection fails)</li>

 <li>Try to identify malicious functions by editing score.h and using the cfg-generation tool</li>

 <li>Discover the list of commands using the symbolic execution tool • Fill the commands in ~/tools/c2-command/stage2-command.txt</li>

 <li>Run it as mentioned before.</li>

</ul>

<h1>Linux Malware</h1>

<ul>

 <li>exe will download stage3 malware, which is payload.exe. This is a linux malware.</li>

 <li>We need to handle the linux malware differently unlike windows malware, and will use different tools and methods to analyze this malware</li>

</ul>

<h1>Linux Malware Tools</h1>

<ul>

 <li>First copy the linux malware into shared folder. The tools which you will use are installed inside the Linux host.</li>

 <li>~/tools/linux_sym_exe.py</li>

 <li>for linux malware symbolic execution</li>

 <li>python linux_sym_exec.py path_to_linux_mw start target</li>

 <li>To make it work, you need to modify two linux_sym_exec.py functions targs_len_before and opts_len_before</li>

 <li>~/tools/dynamicanalysis/</li>

 <li>linux.log : the dynamic instruction trace for the linux malware</li>

 <li>py : you have to modify this file to find the loop in the given trace</li>

 <li>Usage: python detect_loop.py &lt;path-to-debug-file&gt;</li>

 <li>Reverse Engineering Resource:</li>

 <li>Please check <strong>pdf </strong>in Canvas</li>

</ul>

<h1>Linux Malware</h1>

<ul>

 <li>Run ‘python linux_sym_exec.py path_to_linux start target’.</li>

 <li>It won’t be able to find any input because of path explosion. You need to add constraints to make symbolic execution targeted</li>

 <li>Follow the steps in ‘~/report/assignmentquestionnaire.txt’ and find the inputs.</li>

 <li>Analyze the dynamic instruction trace and locate the C&amp;C communication</li>

</ul>

<h1>Tutorial – Copy to Shared Directory</h1>

<ul>

 <li>Once you have followed the previous instructions, you will see that a new malware file has been downloaded.</li>

 <li>You need to copy the malware into the Linux host to analyze it.</li>

 <li>Right-click the downloaded malware on the Desktop, then click “Copy”.</li>

 <li>Open Shared Directory and right-click, then click “Paste”.</li>

</ul>

<h1>Tutorial – Copy to Shared Directory</h1>

<ul>

 <li>If you’re having trouble with file permissions on the XP VM, open a terminal on the Linux host, navigate to the “~/shared” folder, and follow the steps below:</li>

</ul>

<h1>Tutorial – Copy to Shared Directory</h1>

<h1>Tips for assignment-questionnaire.txt</h1>

<ul>

 <li>Complete the questionnaire as you go; try to avoid backtracking as this wastes time</li>

 <li>The URL example in the questionnaire is</li>

</ul>

“http://scouter.cc.gatech.edu/a/b/c”, but some URLs may not include a path (a/b/c after the domain) – this is fine, just be sure to include  the path in your answer for the URLs that include it

<ul>

 <li>The grading script will ignore “http://”, “https://” and “www.” for your convenience, but try to be thorough and match what you see exactly</li>

 <li>Commands and memory addresses are NOT case sensitive, but be sure you don’t mix up 0 (zero) and O – the zero should have a dot in it in the VM</li>

</ul>

<h1>Tips for assignment-questionnaire.txt</h1>

Please use the latest version of VirtualBox when you import the VM. Please do not modify anything related to network settings in the VM.

<ol>

 <li><strong> Domain name</strong></li>

</ol>

On the questionnaire sheet, there are entries for writing domain names. Please follow the following rules on getting answers for those questions.

<ul>

 <li>You should write FQDN, which means, if the full domain name is canof.gtisc.gatech.edu then write canof.gtisc.gatech.edu, not just gatech.edu or gtisc.gatech.edu</li>

 <li>For the others (connections check, DDoS, sending info, etc.), you should get the exact domain name that the malware uses. For example, the IP address 130.207.188.35 belongs to both coe.gatech.edu and web-plesk5.gatech. Because there are multiple mappings, you cannot be sure about which domain that the malware used by just using <strong>nslookup</strong>. In this case, please go through the other way of getting domain names from <strong><em>DNS Packets in Wireshark.</em></strong></li>

</ul>

<strong><em>Please, all Domains should be based on Wireshark DNS packets</em></strong>

(e.g., get it from DNS query packet or redirecting HTTP traffic into local VM and examine Host header).

If you get see the log in the Wireshark, You will find DNS query(Standard query) and DNS response(Standard query response)

In Domain Name System section, there is Query section, like below Queries:

x.y.z: type A, class IN.

Answers:

x.y.z: type CNAME, class IN, cname a.b.c

You should use x.y.z

<h1>Tips forassignment-questionnaire.txt</h1>

<ol start="2">

 <li><strong>URL</strong></li>

</ol>

For all URLs, you do not have to specify the protocol (http:// or https://, etc.). However, if HTTP traffic is like the following: POST /a/b/c/d?asdf=1234 HTTP/1.1 Host: www.zzz.com then please write this as www.zzz.com/a/b/c/d?asdf=1234

<ol start="3">

 <li><strong>Writing commands in *.txt files under c2-command directory</strong></li>

</ol>

There are pre-installed PHP scripts in the VM locally that read the *.txt file for each stage, these scripts send the command to the malware after reading them from the TXT files. One caveat of these scripts is that they are written to send the commands in random order (i.e., if there are commands a, b, c, then the script will randomly choose one command and send it to the malware). So if you want to test ONE command at a time, then please write only that command in the TXT file. For example, if you just want to run the command $uninstall, then please write only that command in stage1-command.txt.

<ol start="4">

 <li><strong>linux_sym_exec and detect_loop for linux malwsare</strong></li>

</ol>

You could use free IDA-Pro, objdump or radare2 for this task to find out called attack functions, and the target addresses. Look for some angr examples on the github, which adds constraints to the state. For the loop detection, focus on function sequence that called repetitive.

<h1>Tips forassignment-questionnaire.txt</h1>

<ol start="5">

 <li><strong> When you think that you found the correct command but malware is not working…</strong></li>

</ol>

Note that some commands for stage 2 are different per each student, by having 4 digit hexadecimal numbers at the end of the command. For example, a command for stage 2 is formatted like

$COMMANDa1b4

(NOTE: two commands in stage 2 have the 4 digit hexadecimal tail. And, all commands in stage 3 have the 4 digit hexadecimal tail on the command.)

However, there could be a case that only gets the front part of the command like

$COMMAND

if the end point address of symbolic execution is not correctly set. In such a case, please set the correct end point that you can get the entire command. <strong>6. Cuckoo</strong>

– In the VM, we provide cuckoo, which is a dynamic malware analysis framework. It is very convenient and easy to use. While you are running cuckoo, you might meet some warnings and errors “critical time blah blah~” and “YARA signature…. blah blah”. Please ignore them. Because you are executing a malware in the QEMU Windows VM, the framework needs to set a time. Cuckoo will check the malware is terminated or not. However, the three malware you will meet are never going to be terminated(Intentionally, modified by me in educational purpose.) So, please ignore “critical time blah blah~, terminating. In our case, the malware is never going to unfold even though you give an infiite time to be executing the malware unless you feed the right inputs(The malware expects C2 commands.) -Iptable setting.

If you check /home/analysis/.cuckoo/conf/kvm.conf you will find how we set the QEMU windows host VM. You will find the IP of the host VM is “192.168.133.101”. If you want to see network behaviors in Cuckoo, you want to forward the IP in /home/analysis/tools/network/iptables-rules.

For example, open iptables-rules, you want to add

sudo iptables -t nat -A PREROUTING -p tcp -s 192.168.133.101 -d [DEST-IP] –dport 80 -j DNAT –to 192.168.133.1:80




<ul>

 <li>Getting the domain name from an IP address (if the packet is encrypted)</li>

 <li>Use nslookup (IP -&gt; domain, and domain name -&gt; IP vice versa)</li>

 <li>Getting the exact domain name from an IP address</li>

 <li>Establish a fake connection (redirect to 192.168.133.1)</li>

 <li>Then look at the TCP stream data</li>

 <li>The HTTP header will contain the answer</li>

 <li>Host: netscan.gtisc.gatech.edu</li>

 <li>Getting the process name of the malware</li>

 <li>Use taskmgr in Windows</li>

 <li>Start menu -&gt; run -&gt; taskmgr; or, press Ctrl-Shift-Esc on Windows.</li>

 <li>Click on the ‘Processes’ tab to see the list of processes</li>

 <li>Or use Cuckoo’s behavioral analysis</li>

 <li>To get the process name of the malware and the registry key that was created by the malware</li>

 <li>Use the Procmon in ProcessMonitor on the testbed VM</li>

 <li>If the malware does not run E.g., not displaying the dialog box with “Starting Stage X malware” on startup</li>

 <li>Try to run stop_malware on the desktop</li>

 <li>This will stop all malware activity, and you can try again with a clean state</li>

 <li>Click OK to proceed with malware execution</li>

 <li>The dialog box pauses execution of the malware</li>

 <li>Click OK whenever this dialog pops-up from the malware</li>

 <li>Otherwise, the malware will not execute further and show its behavior</li>

 <li>Iptables rules</li>

 <li>Edit ~/tools/network/iptables_rules</li>

 <li>Make sure you’ve written your rules correctly (follow the format and double-check your IPs)</li>

 <li>Make sure you execute ./reset on that directory</li>

 <li>This command will update the current iptables rules…</li>

 <li>NAT Redirect Syntax</li>

 <li>iptables -t nat -A PREROUTING -p tcp -s [source-ip-address] -d [destination-ipaddress] — dport 80 -j DNAT –to 192.168.133.1:80</li>

 <li>Insert the rule in the PREROUTING table of NAT,</li>

 <li>And if the protocol is tcp, source ip is matched with [source-ip-address],</li>

 <li>Destination IP is matched with [destination-ip-address], and destination port is 80</li>

 <li>Then redirect this traffic to 192.168.133.1, port 80.</li>

</ul>




<h2>Miscellaneous VM Performance Tips (taken from Piazza)</h2>

<strong><em>Part 1 : Windows Malware / Generic VM Issues </em></strong>• <strong>Try lowering your screen resolution</strong>

<ul>

 <li><strong>Save often!</strong></li>

 <li>Avoid using a resource heavy IDE like IntelliJ, Eclipse etc. Lightweight alternatives include gedit, vim, emacs, Sublime Text, Visual Studio Code, nano, etc</li>

</ul>

Most importantly, do / run only 1 task at a time. That means •Run the Windows VM only when:

1.Sending commands to malware

2.Analyzing network traffic via Wireshark

3.Once done with those tasks, turn off the Windows VM.

<ul>

 <li>Avoid running the windows VM when:</li>

</ul>

1.Running cuckoo analysis

2.Generating CFGs

3.Running Symbolic Execution – This is quite resource intensive, avoid doing other stuff to get this done quickly. (TIP: If this seems to be taking infinite memory/time, your mostly trying to reach a unreachable / invalid address ! check your addresses !)

<ul>

 <li>Try running the VM at a lower resolution (recommend at-least 1280×800, for legibility) – If you have a very high resolution on your host machine (I had 2560×1440, this may impact the VM performance). You can do this in 2 ways</li>

</ul>

1.VirtualBox Menu – View &gt; Virtual Screen 1 &gt; Resize to a x b

2.Ubuntu Menu – Type “Displays” &gt; Change it there

<ul>

 <li>Restart after a task / stage. This is mostly a last resort but restarting the VM after finishing a task/stage made everything feel really smooth for me, instead of trying to free memory etc. Just be sure to run ./reset in ~/tools/networks after each VM restart!</li>

</ul>

<strong><em>Part 2 : Android</em></strong>

Some of the above stuff applies here (VM Settings, resolution, etc). Restarting after working on Part 1, helps a lot.

If you still really feel your android emulator is slow you can add the following flags to the <strong>emulator </strong>command flags in <strong><em>~/bin/run-emulator</em></strong>

-memory 2048 -gpu swiftshader

You can experiment with RAM allocation and CPU usage based on your machine – but keep in mind that the project VM has only been tested at 4 GB and with 2 or 3 CPUs.

<ul>

 <li>For those of you who are interested in Reverse Engineering, these slides cover fundamental material for you to study.</li>

 <li>Dissembler/Debugger</li>

 <li>IDA Pro, binary ninja, radare2, x64 dbg, GDB, immunity debugger, etc.</li>

 <li>Packer/Obfuscation</li>

 <li>Ether, VMIUnpacker, xorunpacker, etc.</li>

 <li>PE/ELF binary format</li>

 <li>Memory snapshot</li>

 <li>More…</li>

 <li>Most malware are packed or obfuscated by a known/unknown packer or obfuscator.</li>

 <li>For Win32 binaries, by checking the PE32 format, we can see whether the binary is packed.</li>

 <li>For obfuscation, we usually need to reverse engineer to determine if the binary is obfuscated.</li>

 <li>Assembly code &amp; OS architecture</li>

 <li>X86, x86-64, arm64, etc.</li>

 <li>Stack, heap, canary, guardian, etc.</li>

 <li>An example:</li>

 <li>Anti debugging/Anti VM techniques</li>

 <li>Malware is becoming more advanced.</li>

 <li>Malware authors know that:</li>

 <li>Malware analysts use debugging/disassembler tools</li>

 <li>Malware analysts use VM environments</li>

 <li>Malware authors embed evasive techniques to thwart debugging software and VM environments.</li>

 <li>Detection of software/hardware breakpoints</li>

 <li>Detection of memory/conditional breakpoints</li>

 <li>Timing/Artifact based VM detection</li>

</ul>




<h1>Android Malware Analysis</h1>

<ul>

 <li>Manifest Analysis</li>

 <li>Identifying suspicious components</li>

 <li>Static Analysis</li>

 <li>Search for C&amp;C commands and trigger conditions</li>

 <li>Vet the app for any anti-analysis techniques that need to be removed.</li>

 <li>Dynamic analysis</li>

 <li>Leverage the information found via static analysis to trigger the malicious behavior.</li>

</ul>

<h1>Manifest Analysis</h1>

<ul>

 <li>Identify suspicious components</li>

 <li>Broadcast receivers registering for suspicious actions.</li>

 <li>Background services</li>

 <li>Narrow the scope of analysis</li>

 <li>Malicious apps are repackaged in benign apps with thousands of classes.</li>

</ul>

Broadcast receiver from CoinPirate’s malware family.

<h1>Static Analysis</h1>

<ul>

 <li>Search for C&amp;C commands and trigger conditions</li>

</ul>

<h1>Static Analysis</h1>

<ul>

 <li>Identifying Anti-analysis techniques</li>

</ul>

<h1>Scenario</h1>

Analyzing Android Malware

<ul>

 <li>You have received a malware sample <strong>apk. </strong>• You need to identify communication with the C&amp;C server</li>

 <li>Identify anti-analysis techniques being used by the app.</li>

 <li>Identify commands that trigger any malicious behavior.</li>

</ul>

<h1>Project Structure</h1>

<ul>

 <li>Android emulator</li>

 <li>An emulator for Android 4.4 is pre-installed</li>

 <li>Run ‘run-emulator’</li>

 <li>This will start the Android emulator (this takes a long time, especially the first time you start it)</li>

 <li>Jadx</li>

 <li>Disassembles apk files into Java source code.</li>

 <li>Apktool</li>

 <li>Disassembles apk file into Smali.</li>

 <li>Rebuilds apk files.</li>

 <li>Write-up (~/Android/MaliciousMessenger/writeup.pdf)</li>

 <li>Detailed guide on how to complete the Android section of the lab.</li>

</ul>

<h1>Project Structure</h1>

<ul>

 <li>Android App</li>

 <li>~/Android/MaliciousMessenger/tutorialApps</li>

 <li>emu-check.apk</li>

 <li>A tutorial example (Shown as ‘My application’ in the emulator)</li>

 <li>apk</li>

 <li>Another tutorial example</li>

 <li>~/Android/MaliciousMessenger/sms.apk</li>

 <li>Target app to analyze to answer the questionnaire</li>

 <li><strong>READ ~/Android/MaliciousMessenger/writeup.pdf</strong></li>

</ul>

<h1>Starting C&amp;C Server</h1>

<ul>

 <li>Starting C&amp;C Server</li>

 <li>Run `start_server`</li>

</ul>

<h1>Things To Take Note of…</h1>

<ul>

 <li>If something goes wrong and you don’t find the emulator already setup, run the following commands to handle it:</li>

 <li>run-emulator adb emulator-5554 install tutorialApps/emu-check.apk</li>

 <li>run-emulator adb emulator-5554 install tutorialApps/CoinPirate.apk</li>

 <li>run-emulator adb emulator-5554 install sms.apk</li>

</ul>




<ul>

 <li>Emulator</li>

 <li>Run with ‘run-emulator’</li>

 <li>Emulator</li>

 <li>Run Application</li>

 <li>My Application (tutorial, not required)</li>

 <li>emu-check.apk</li>

 <li>Coin Pirates (tutorial, not required)</li>

 <li>apk</li>

 <li>Messenger</li>

 <li>apk (analysis target)</li>

 <li>Emulator</li>

 <li>Click ‘…’ to control the emulator</li>

 <li>Emulator</li>

 <li>Send SMS</li>

 <li>Can change sender ID</li>

 <li>Can change content</li>

 <li>Decompile</li>

 <li>Run jadx-gui</li>

 <li>Disassemble</li>

 <li>Run apktool</li>

 <li>apktool d –f –r sms.apk</li>

 <li>This command generates decompilied *.smali files</li>

 <li>Save a copy of the APK file before doing this.</li>

 <li>Repackage (requires signing)</li>

 <li>apktool b sms –o sms.apk</li>

 <li>This command will re-assemble *.smali files into an apk file (as sms.apk, you can change this)</li>

 <li>Sign</li>

 <li>You should sign the app to install the app to emulator</li>

 <li>Run ‘apksigner sign −−ks ~/.android/debug.keystore sms.apk’</li>

 <li>Password is ‘android’</li>

 <li>Install / uninstall (you should uninstall first to re-install the app)</li>

 <li>Install</li>

 <li>adb install sms.apk</li>

 <li>This command will install sms.apk into the emulator</li>

 <li>Make sure to turn on the emulator first</li>

 <li>adb uninstall com.smsmessenger</li>

 <li>This command will uninstall sms.apk from the emulator</li>

 <li>Decompile</li>

 <li>Run jadx-gui</li>

 <li>Open apk file</li>

 <li>Open class…</li>

</ul>




<h2>Android Tip</h2>

<ul>

 <li>Be sure that you do NOT include the “+” character as part of your phone number, even before the country code</li>

 <li>For example, use “5 123 456 7890”, NOT “+5 123 456 7890”</li>

</ul>

Android Cheatsheet (thanks to Joey Allen)

<ul>

 <li><strong>Start Emulator</strong>~/bin/run-emulator</li>

 <li><strong>Add Contact</strong></li>

</ul>

The sleeps are needed to allow a slow emulator time to process adb shell “am start -a android.intent.action.INSERT -t vnd.android.cursor.dir/contact -e name ‘GatechID'” sleep 1 adb shell input keyevent 4 sleep 1 adb shell input keyevent 4 •<strong>Android Log </strong>adb logcatReference: <a href="http://adbshell.com/commands/adb-logcat">abd</a><a href="http://adbshell.com/commands/adb-logcat">–</a><a href="http://adbshell.com/commands/adb-logcat">logcat</a>

<ul>

 <li><strong>Filtered log</strong></li>

</ul>

The adb tool has no way to filter by app, fortunately there’s a script that’ll do just that. colors!

Get the script and make it executable (review it before running something off the internet &#x1f610; ) wget -O ~/bin/pidcat.py https://raw.githubusercontent.com/JakeWharton/pidcat/master/pidcat.py chmod +x ~/bin/pidcat.py Monitor the malware log~/bin/pidcat.py com.smsmessengerReference: <a href="https://github.com/JakeWharton/pidcat">pidcat</a>

<ul>

 <li><strong>Decompile APK</strong></li>

</ul>

Note: Omitting the -r,–no-res option allows it to decode the resources as well as the smali code. apktool decode ~/Android/MaliciousMessenger/sms.apk –output ~/Android/MaliciousMessenger/sms

<ul>

 <li><strong>Build Modified APK </strong>apktool build ~/Android/MaliciousMessenger/sms –output ~/Android/MaliciousMessenger/sms_modded.apk</li>

 <li><strong>Sign Modified APK</strong>~/bin/signer.py ~/Android/MaliciousMessenger/sms_modded.apk</li>

 <li><strong>Uninstall APK</strong>adb uninstall com.smsmessenger</li>

 <li><strong>Install Modified APK</strong>adb install ~/Android/MaliciousMessenger/sms_modded.apk</li>

 <li><strong>Launch the app</strong></li>

</ul>

The app will not be active until you run it at least once after re-installation &#x1f621;, spent a bunch of time banging my head against the wall until i figured this one out.adb shell monkey -p com.smsmessenger -c android.intent.category.LAUNCHER 1

<ul>

 <li><strong>Send an SMS</strong></li>

</ul>

Use single quotes or you’ll need to escape the message contents. Note: I didn’t test with emojis! adb emu sms send 8675309 ‘&#x1f3b5; Jenny Ive called your number…&#x1f3b5;’

<ul>

 <li><strong>Enable Ubuntu Workspaces</strong></li>

</ul>

This is a personal preference but it makes it easier to separate the work into different contexts gsettings set org.compiz.core:/org/compiz/profiles/unity-lowgfx/plugins/core/ hsize 2 gsettings set org.compiz.core:/org/compiz/profiles/unity-lowgfx/plugins/core/ vsize 2 Or if you prefer using the mouse change the settings: Start -&gt; Appearance -&gt; Behavior -&gt; Enable Workspaces

<h2>Questionnaire</h2>

<ul>

 <li><strong><em><u>1) To get credit for the project, you have to answer the</u></em></strong><strong><em> <u>questionnaire, found at ~/report/assignment-questionnaire.txt !!!!!</u></em></strong></li>

 <li><strong><em><u>2) Please strictly follow the format or the example answer for each question in assignment-questionnaire.txt. TAs use a autograder</u></em></strong></li>

</ul>

<strong><em><u>for your submission.</u></em></strong>

<ul>

 <li>Windows Part</li>

 <li>Read <strong>~/report/assignment-questionnaire.txt</strong></li>

 <li>Carefully read the questions, and answer them in <strong>~/report/assignmentquestionnaire.txt </strong> For each stage, there are 4-6 questions regarding the behavior of the malware.</li>

 <li>Android Part</li>

 <li><strong>READ ~/Android/MaliciousMessenger/writeup.pdf</strong></li>

 <li>Carefully read the writeup, answer in <strong>~/report/assignment-questionnaire.txt</strong></li>

 <li>Make sure you overwrite ANSWER_HERE</li>

</ul>

<h2>Submitting Questionnaire</h2>

<ul>

 <li>Required files</li>

 <li>Zip the following files and upload report.zip to Canvas</li>

 <li>Running ~/archive.sh will automatically zip all of the files</li>

 <li>~/report/assignment-questionnaire.txt</li>

 <li>exe, stage2.exe, payload.exe (linux malware)</li>

 <li>~/tools/network/iptables_rules • ~/tools/cfg-generation/score.h</li>

 <li>Running ~/archive.sh will create report.zip automatically</li>

 <li>Please check the content of your zip file before submitting it to Canvas</li>

</ul>

<h2>Typos in Questionnaire</h2>

<h2>Project 3 Rubric</h2>

* – The value for each max score is within its particular section – Windows has 110 possible points, and Android has 100. As each section is worth an equal amount of your overall P2 grade, we normalized the Windows score by dividing by 1.1 (and rounded up), then averaged it with the Android score to get your final grade. So effectively, each point in the table above is worth half a point of your final project grade (slightly less for Windows).

** – If Partial Credit column is blank, there is no partial credit for the question. “Ratio” refers to Levenshtein ratio, it’s a metric of similarity between strings.